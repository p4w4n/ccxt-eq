- [Zerodha_auto_token_example](./examples/py/)


 ```python
 #!/usr/bin/env python3
"""
Example of using CCXT Zerodha with automated token loading.

This example shows how to automatically load the access token from
the cache file generated by zerodha_auto_token.py
"""

import json
import sys
from pathlib import Path
from datetime import datetime
import pytz

# Add parent directory to path to import ccxt
sys.path.append(str(Path(__file__).parent.parent.parent))

import ccxt


def load_cached_token():
    """Load access token from cache file."""
    token_file = Path.home() / '.cache' / 'ccxt-zerodha' / 'token.json'
    
    if not token_file.exists():
        print(f"Token file not found: {token_file}")
        print("Please run: python scripts/zerodha_auto_token.py")
        return None
    
    try:
        with open(token_file, 'r') as f:
            token_data = json.load(f)
        
        access_token = token_data.get('access_token')
        login_time = token_data.get('login_time')
        
        # Check if token is still valid
        if login_time:
            ist = pytz.timezone('Asia/Kolkata')
            login_dt = datetime.fromisoformat(login_time.replace('Z', '+00:00'))
            if login_dt.tzinfo is None:
                login_dt = ist.localize(login_dt)
            else:
                login_dt = login_dt.astimezone(ist)
            
            now_ist = datetime.now(ist)
            
            # Token expires at 6 AM IST the next day
            expiry_time = login_dt.replace(hour=6, minute=0, second=0, microsecond=0)
            if login_dt.hour >= 6:
                from datetime import timedelta
                expiry_time += timedelta(days=1)
            
            if now_ist >= expiry_time:
                print(f"Token has expired at {expiry_time.strftime('%Y-%m-%d %H:%M:%S IST')}")
                print("Please run: python scripts/zerodha_auto_token.py")
                return None
            
            print(f"Token is valid until {expiry_time.strftime('%Y-%m-%d %H:%M:%S IST')}")
        
        return access_token
        
    except Exception as e:
        print(f"Error loading token: {e}")
        return None


def main():
    """Main example function."""
    
    # Load API credentials from environment or config
    import os
    from dotenv import load_dotenv
    
    load_dotenv()
    
    api_key = os.getenv('ZERODHA_API_KEY')
    api_secret = os.getenv('ZERODHA_API_SECRET')
    
    if not api_key or not api_secret:
        print("Please set ZERODHA_API_KEY and ZERODHA_API_SECRET in .env file")
        return
    
    # Load access token from cache
    access_token = load_cached_token()
    if not access_token:
        return
    
    # Create exchange instance with auto-loaded token
    try:
        exchange = ccxt.zerodha({
            'apiKey': api_key,
            'secret': api_secret,
            'password': access_token,  # Access token goes in password field
            'enableRateLimit': True,
        })
        
        print("\n=== Zerodha CCXT Example ===\n")
        
        # Load markets
        print("Loading markets...")
        markets = exchange.load_markets()
        print(f"Loaded {len(markets)} markets")
        
        # Show some popular stocks
        popular_symbols = [
            'NSE:RELIANCE/INR',
            'NSE:TCS/INR',
            'NSE:INFY/INR',
            'NSE:HDFC/INR',
            'NSE:ICICIBANK/INR'
        ]
        
        print("\nSample markets:")
        for symbol in popular_symbols:
            if symbol in markets:
                market = markets[symbol]
                print(f"  {symbol}: {market['base']} / {market['quote']}")
        
        # Fetch account balance
        print("\nFetching account balance...")
        balance = exchange.fetch_balance()
        
        print("\nCash Balance:")
        if 'INR' in balance:
            print(f"  INR: {balance['INR']['free']} free, {balance['INR']['total']} total")
        
        print("\nStock Holdings:")
        for asset, bal in balance.items():
            if asset != 'INR' and asset != 'info' and bal['total'] > 0:
                print(f"  {asset}: {bal['total']} shares")
        
        # Fetch ticker for a symbol
        symbol = 'NSE:RELIANCE/INR'
        if symbol in markets:
            print(f"\nFetching ticker for {symbol}...")
            ticker = exchange.fetch_ticker(symbol)
            print(f"  Last Price: ₹{ticker['last']}")
            print(f"  Bid: ₹{ticker['bid']} | Ask: ₹{ticker['ask']}")
            print(f"  Volume: {ticker['baseVolume']}")
        
        # Example: Place a limit order (commented out for safety)
        # WARNING: This will place a real order if uncommented!
        """
        print("\nExample order (not executed):")
        order_params = {
            'symbol': 'NSE:INFY/INR',
            'type': 'limit',
            'side': 'buy',
            'amount': 1,  # 1 share
            'price': 1400.00,  # Limit price
            'params': {
                'product': 'CNC'  # Required: CNC for delivery
            }
        }
        print(f"  Order: Buy {order_params['amount']} {order_params['symbol']} @ ₹{order_params['price']}")
        
        # To actually place the order, uncomment:
        # order = exchange.create_order(**order_params)
        # print(f"  Order placed: {order['id']}")
        """
        
        # Fetch recent orders
        print("\nFetching recent orders...")
        try:
            open_orders = exchange.fetch_open_orders()
            print(f"  Open orders: {len(open_orders)}")
            
            closed_orders = exchange.fetch_closed_orders()
            print(f"  Recent closed orders: {len(closed_orders)}")
            
            if closed_orders:
                latest = closed_orders[0]
                print(f"\n  Latest order:")
                print(f"    ID: {latest['id']}")
                print(f"    Symbol: {latest['symbol']}")
                print(f"    Type: {latest['type']} {latest['side']}")
                print(f"    Status: {latest['status']}")
                
        except Exception as e:
            print(f"  Error fetching orders: {e}")
        
        print("\n=== Example completed successfully ===")
        
    except ccxt.BaseError as e:
        print(f"\nCCXT Error: {type(e).__name__}: {e}")
    except Exception as e:
        print(f"\nUnexpected error: {e}")
        import traceback
        traceback.print_exc()


if __name__ == '__main__':
    main()  
```